<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>数据分析后台</title>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body { background-color: #f2f2f7; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", sans-serif; }
    .app-card { transition: all 0.2s; cursor: pointer; }
    .app-card:hover { transform: translateY(-3px); box-shadow: 0 10px 20px rgba(0,0,0,0.12); }
    .active-app { border-color: #007aff; box-shadow: 0 5px 15px rgba(0, 122, 255, 0.2); }

    /* Drawer & overlay */
    .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.35); z-index: 40; opacity: 0; transition: opacity 0.25s; pointer-events: none; }
    .overlay.show { opacity: 1; pointer-events: auto; }
    .drawer { position: fixed; top: 0; right: -100%; width: 92%; max-width: 760px; height: 100%; background: #fff; box-shadow: -8px 0 30px rgba(0,0,0,0.25); transition: right 0.28s cubic-bezier(.2,.9,.2,1); z-index: 50; overflow-y: auto; padding: 20px; -webkit-overflow-scrolling: touch; border-left: 1px solid rgba(0,0,0,0.06); }
    .drawer.open { right: 0; }
    .drawer-close { position: absolute; top: 10px; right: 10px; cursor: pointer; font-size: 20px; font-weight: bold; }

    /* small helpers */
    .sort-btn { padding: 6px 10px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.08); background: #fff; }
    .search-input { padding: 8px 12px; border-radius: 8px; border: 1px solid rgba(0,0,0,0.08); width: 100%; }
    .table-container { overflow-x: auto; }
  </style>
</head>
<body class="min-h-screen p-4">

  <header class="text-center mb-6">
    <h1 class="text-3xl font-bold text-gray-800">数据分析后台</h1>
    <p class="text-gray-500 mt-1">查看 VPN Proxy / LumoTalk 的用户数据和留存情况</p>
  </header>

  <!-- 管理员ID输入 -->
  <div class="max-w-lg mx-auto mb-6">
    <label class="block text-gray-700 mb-1">管理员ID（必填）</label>
    <input id="adminId" type="text" placeholder="输入管理员ID" class="w-full p-2 border rounded">
  </div>

  <!-- App选择 -->
  <div class="flex justify-center gap-4 mb-2 flex-wrap">
    <div id="appVpnProxy" class="app-card border border-gray-300 rounded-lg p-4 active-app">
      <h2 class="font-semibold text-lg text-gray-800">VPN Proxy</h2>
    </div>
    <div id="appLumoTalk" class="app-card border border-gray-300 rounded-lg p-4">
      <h2 class="font-semibold text-lg text-gray-800">LumoTalk</h2>
    </div>
  </div>

  <div class="max-w-lg mx-auto mb-6">
    <p class="text-center text-gray-600" id="currentAppStatus">当前选择 App：<span class="font-semibold text-blue-600">VPN Proxy</span></p>
  </div>

  <!-- 查询表单 -->
  <div class="max-w-lg mx-auto bg-white p-6 rounded-xl shadow mb-6">
    <div class="flex flex-col space-y-4">
      <div>
        <label class="block text-gray-700 mb-1">开始日期</label>
        <input id="startDate" type="date" class="w-full p-2 border rounded">
      </div>
      <div>
        <label class="block text-gray-700 mb-1">结束日期</label>
        <input id="endDate" type="date" class="w-full p-2 border rounded">
      </div>
      <div>
        <label class="block text-gray-700 mb-1">国家</label>
        <select id="countrySelect" class="w-full p-2 border rounded">
          <option value="">全部</option>
          <option value="3">中国</option>
          <option value="0">土耳其</option>
          <option value="1">阿拉伯</option>
        </select>
      </div>
      <div>
        <label class="block text-gray-700 mb-1">查询类型</label>
        <select id="action" class="w-full p-2 border rounded">
          <option value="retention">留存率</option>
          <option value="userIds">用户列表</option>
          <option value="userData">单用户数据</option>
          <option value="vipCount">VIP人数</option>
        </select>
      </div>
      <div id="userIdInputWrapper" class="hidden">
        <label class="block text-gray-700 mb-1">用户ID</label>
        <input id="userIdInput" type="text" placeholder="输入用户ID查询单用户" class="w-full p-2 border rounded">
      </div>
      <button id="fetchBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded font-semibold transition-all">查询</button>
    </div>
  </div>

  <!-- 图表 -->
  <div class="max-w-4xl mx-auto bg-white p-6 rounded-xl shadow mb-6">
    <canvas id="retentionChart"></canvas>
  </div>

  <!-- 控件：用户列表搜索 & 排序 -->
  <div id="userListControls" class="max-w-4xl mx-auto bg-white p-4 rounded-xl shadow mb-4 hidden">
    <div class="flex gap-3 items-center flex-wrap">
      <input id="userListSearch" class="search-input flex-1 min-w-[180px]" placeholder="搜索用户（user_id / 国家 / 设备 等）" />
      <button id="userListSortBtn" class="sort-btn">按时间 ↓</button>
    </div>
  </div>

  <!-- 用户数据显示 -->
  <div id="userDataContainer" class="max-w-4xl mx-auto mb-6 table-container overflow-x-auto"></div>

  <!-- overlay & 单用户抽屉 -->
  <div id="overlay" class="overlay"></div>

  <div id="userDrawer" class="drawer" role="dialog" aria-modal="true" aria-hidden="true">
    <span class="drawer-close" id="drawerClose" title="关闭">&times;</span>
    <div class="mb-4">
      <div class="flex gap-2 items-center mb-3">
        <input id="drawerSearch" class="search-input flex-1" placeholder="在该用户日志中搜索（输入即筛）" />
        <button id="drawerSortBtn" class="sort-btn">按时间 ↓</button>
      </div>
      <h2 class="text-xl font-bold mb-2 text-gray-800">用户详情</h2>
    </div>
    <div id="drawerContent"></div>
  </div>

<script>
let selectedApp = { name: "VPN Proxy", table: "vpnproxy" };
const appVpnProxy = document.getElementById('appVpnProxy');
const appLumoTalk = document.getElementById('appLumoTalk');
const currentAppStatus = document.getElementById('currentAppStatus');
const retentionChart = document.getElementById('retentionChart');
const userDataContainer = document.getElementById('userDataContainer');
const drawer = document.getElementById('userDrawer');
const drawerContent = document.getElementById('drawerContent');
const drawerClose = document.getElementById('drawerClose');
const adminIdInput = document.getElementById('adminId');
const userIdInputWrapper = document.getElementById('userIdInputWrapper');
const userIdInput = document.getElementById('userIdInput');
const overlay = document.getElementById('overlay');
const userListControls = document.getElementById('userListControls');
const userListSearch = document.getElementById('userListSearch');
const userListSortBtn = document.getElementById('userListSortBtn');
const drawerSearch = document.getElementById('drawerSearch');
const drawerSortBtn = document.getElementById('drawerSortBtn');
const countrySelect = document.getElementById('countrySelect');

let chartInstance = null;
let userListData = [], userListView = [], singleUserData = [], singleUserView = [];
let userListSortAsc = false, drawerSortAsc = false;
let touchStartX = null, touchStartY = null;

/* ========== app 选择 ========== */
appVpnProxy.addEventListener('click', () => selectApp('VPN Proxy', 'vpnproxy'));
appLumoTalk.addEventListener('click', () => selectApp('LumoTalk', 'lumotalk'));

function selectApp(name, table) {
  selectedApp = { name, table };
  appVpnProxy.classList.toggle('active-app', name === 'VPN Proxy');
  appLumoTalk.classList.toggle('active-app', name === 'LumoTalk');
  currentAppStatus.innerHTML = `当前选择 App：<span class="font-semibold text-blue-600">${name}</span>`;
  if(chartInstance) { chartInstance.destroy(); chartInstance=null; }
  userDataContainer.innerHTML='';
  clearUserListState();
}

/* ========== action 切换控制 ========== */
document.getElementById('action').addEventListener('change', (e) => {
  const val = e.target.value;
  if(val==='userData') {
    userIdInputWrapper.classList.remove('hidden');
    userListControls.classList.add('hidden');
    clearUserListState();
  } else if(val==='userIds') {
    userIdInputWrapper.classList.add('hidden');
    userListControls.classList.remove('hidden');
  } else {
    userIdInputWrapper.classList.add('hidden');
    userListControls.classList.add('hidden');
    clearUserListState();
  }
});

/* ========== 辅助函数 ========== */
function vipStatusLabel(status) {
  switch(status){
    case 1: return '<span class="text-white bg-green-500 px-2 py-1 rounded-full text-xs">当前会员</span>';
    case 2: return '<span class="text-white bg-orange-500 px-2 py-1 rounded-full text-xs">会员未续费</span>';
    default: return '<span class="text-gray-500 bg-gray-200 px-2 py-1 rounded-full text-xs">普通用户</span>';
  }
}
function formatDateStr(s){ return s||'-'; }

/* ========== 渲染用户列表为表格 ========== */
function renderUserData(data,isUserIdList=false){
  userDataContainer.innerHTML='';
  if(!data || data.length===0){
    userDataContainer.innerHTML='<p class="text-gray-500 text-center">没有数据</p>';
    return;
  }
  if(isUserIdList){
    const table = document.createElement('table');
    table.className='min-w-full border border-gray-200 text-sm';
    const thead = document.createElement('thead');
    thead.innerHTML = `
      <tr class="bg-gray-100">
        <th class="p-2 border">UserID</th>
        <th class="p-2 border">国家</th>
        <th class="p-2 border">设备</th>
        <th class="p-2 border">VIP状态</th>
        <th class="p-2 border">操作</th>
      </tr>
    `;
    table.appendChild(thead);
    const tbody = document.createElement('tbody');
    data.forEach(item=>{
      const tr = document.createElement('tr');
      tr.className='hover:bg-gray-50';
      tr.innerHTML=`
        <td class="p-2 border text-blue-600 font-semibold">${item.user_id}</td>
        <td class="p-2 border">${item.country_code||'-'}</td>
        <td class="p-2 border">${item.device||'-'}</td>
        <td class="p-2 border">${vipStatusLabel(item.vip_status)}</td>
        <td class="p-2 border"><button class="px-2 py-1 border rounded open-user-btn" data-userid="${item.user_id}">打开</button></td>
      `;
      tbody.appendChild(tr);
    });
    table.appendChild(tbody);
    userDataContainer.appendChild(table);

    // 给按钮绑定事件
    userDataContainer.querySelectorAll('.open-user-btn').forEach(btn=>{
      btn.addEventListener('click',e=>{
        e.stopPropagation();
        fetchSingleUserData(btn.dataset.userid);
      });
    });
  } else {
    data.forEach(item=>{
      const card = document.createElement('div');
      card.className='bg-white p-4 rounded-xl shadow mb-2';
      card.innerHTML=`
        <p class="font-semibold text-blue-600">UserID: ${item.user_id}</p>
        <p class="text-gray-800">${item.name||'-'}</p>
        <p class="text-gray-500 text-sm">时间: ${formatDateStr(item.log_time)}</p>
      `;
      userDataContainer.appendChild(card);
    });
  }
}

/* ========== 查询按钮逻辑（带国家参数和时间处理） ========== */
document.getElementById('fetchBtn').addEventListener('click', async()=>{
  if(!adminIdInput.value.trim()){ alert('请输入管理员ID'); return; }
  const startDateInput=document.getElementById('startDate').value;
  const endDateInput=document.getElementById('endDate').value;
  const action=document.getElementById('action').value;
  const userIdVal=userIdInput.value.trim();
  const countryVal=countrySelect.value;

  if((action==='retention'||action==='userIds'||action==='vipCount') && (!startDateInput||!endDateInput)){ alert('请选择开始和结束日期'); return; }
  if(action==='userData' && !userIdVal){ alert('请输入用户ID'); return; }

  // ======== 根据国家处理时间 ========
  function formatDateWithTime(dateObj){
    const y = dateObj.getFullYear();
    const m = String(dateObj.getMonth()+1).padStart(2,'0');
    const d = String(dateObj.getDate()).padStart(2,'0');
    const h = String(dateObj.getHours()).padStart(2,'0');
    const min = String(dateObj.getMinutes()).padStart(2,'0');
    const s = String(dateObj.getSeconds()).padStart(2,'0');
    return `${y}-${m}-${d} ${h}:${min}:${s}`;
  }

  let startDate = new Date(startDateInput);
  let endDate = new Date(endDateInput);

  if(countryVal === '0'){ // 土耳其
      startDate.setHours(0 + 5, 0, 0, 0);
      endDate.setHours(23 + 5, 59, 59, 999);
  } else if (countryVal === '1') {
      //阿拉伯
      startDate.setHours(0 + 5, 0, 0, 0);
      endDate.setHours(23 + 5, 59, 59, 999);
  }
  else { // 中国/全部/其他
      startDate.setHours(0, 0, 0, 0);
      endDate.setHours(23, 59, 59, 999);
  }


  const finalStartDate = formatDateWithTime(startDate);
  const finalEndDate = formatDateWithTime(endDate);
  
  console.log(finalStartDate)
  console.log(finalEndDate)

  const url=new URL('https://analyze.yuanma.live/event');
  url.searchParams.append('action',action);
  url.searchParams.append('table',selectedApp.table);
  url.searchParams.append('adminId',adminIdInput.value.trim());
  if(startDateInput) url.searchParams.append('startDate',finalStartDate);
  if(endDateInput) url.searchParams.append('endDate',finalEndDate);
  if(action==='userData') url.searchParams.append('userId',userIdVal);
  if(action==='userIds') url.searchParams.append('country',countryVal);

  try{
    const res = await fetch(url);
    const data = await res.json();
    if(action==='userIds'){
      userListData=Array.isArray(data)?data:[];
      userListSortAsc=false;
      userListSearch.value='';
      userListControls.classList.remove('hidden');
      applyUserListFilteringAndSorting();
      if(chartInstance){chartInstance.destroy();chartInstance=null;}
    } else if(action==='retention'){
      renderUserData([]);
      const labels = data.map(item=>item.date);
      const newUser = data.map(item=>item.new_user_count);
      const retention = data.map(item=>item.day1_retention);
      const retentionRate = data.map(item=>(item.day1_rate||0)*100);
      if(chartInstance) chartInstance.destroy();
      chartInstance = new Chart(retentionChart,{
        type:'line',
        data:{labels,datasets:[
          {label:'新用户',data:newUser,borderColor:'blue',backgroundColor:'rgba(0,0,255,0.1)'},
          {label:'Day1留存',data:retention,borderColor:'green',backgroundColor:'rgba(0,255,0,0.1)'},
          {label:'留存率 %',data:retentionRate,borderColor:'orange',backgroundColor:'rgba(255,165,0,0.1)'}
        ]},
        options:{responsive:true,interaction:{mode:'index',intersect:false},plugins:{tooltip:{mode:'index',intersect:false}}}
      });
    } else if(action==='userData'){
      singleUserData=Array.isArray(data)?data:[];
      singleUserView=[...singleUserData];
      renderDrawerContent(singleUserView);
      openDrawer();
    } else if(action==='vipCount'){
      userDataContainer.innerHTML='<pre class="p-4 bg-gray-100 rounded-xl">'+JSON.stringify(data,null,2)+'</pre>';
    }
  }catch(e){
    console.error(e);
    alert('请求失败，请检查控制台');
  }
});

/* ========== 用户列表搜索/排序 ========== */
function applyUserListFilteringAndSorting(){
  const searchText = userListSearch.value.trim().toLowerCase();
  userListView = userListData.filter(u=>{
    return !searchText || [u.user_id,u.country_code,u.device,u.device_detail].some(v=>v?.toString().toLowerCase().includes(searchText));
  });
  userListView.sort((a,b)=>{
    const tA=new Date(a.create_time).getTime();
    const tB=new Date(b.create_time).getTime();
    return userListSortAsc? tA-tB : tB-tA;
  });
  renderUserData(userListView,true);
}
userListSearch.addEventListener('input',applyUserListFilteringAndSorting);
userListSortBtn.addEventListener('click',()=>{
  userListSortAsc=!userListSortAsc;
  applyUserListFilteringAndSorting();
});

/* ========== 单用户抽屉 ========== */
function fetchSingleUserData(userId){
  document.getElementById('action').value='userData';
  userIdInput.value=userId;
  document.getElementById('fetchBtn').click();
}
function renderDrawerContent(data){
  drawerContent.innerHTML='';
  if(!data || data.length===0){ drawerContent.innerHTML='<p class="text-gray-500">没有日志数据</p>'; return; }
  const table = document.createElement('table');
  table.className='min-w-full border border-gray-200 text-sm';
  const thead = document.createElement('thead');
  thead.innerHTML='<tr class="bg-gray-100"><th class="p-2 border">时间</th><th class="p-2 border">事件</th><th class="p-2 border">内容</th></tr>';
  table.appendChild(thead);
  const tbody = document.createElement('tbody');
  data.forEach(item=>{
    const tr=document.createElement('tr');
    tr.className='hover:bg-gray-50';
    tr.innerHTML=`<td class="p-2 border">${item.time||'-'}</td><td class="p-2 border">${item.event||'-'}</td><td class="p-2 border">${item.detail||'-'}</td>`;
    tbody.appendChild(tr);
  });
  table.appendChild(tbody);
  drawerContent.appendChild(table);
}
function openDrawer(){ drawer.classList.add('open'); overlay.classList.add('show'); }
function closeDrawer(){ drawer.classList.remove('open'); overlay.classList.remove('show'); }
drawerClose.addEventListener('click',closeDrawer);
overlay.addEventListener('click',closeDrawer);

/* ========== 用户列表状态清理 ========== */
function clearUserListState(){ userListData=[]; userListView=[]; userDataContainer.innerHTML=''; userListControls.classList.add('hidden'); }

/* ========== 抽屉触控事件支持 ========== */
drawer.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].clientX; touchStartY = e.changedTouches[0].clientY; });
drawer.addEventListener('touchend', e => {
  const dx = e.changedTouches[0].clientX - touchStartX;
  const dy = e.changedTouches[0].clientY - touchStartY;
  if(Math.abs(dx) > 80 && Math.abs(dy) < 40 && dx > 0){ closeDrawer(); }
});
</script>
</body>
</html>
