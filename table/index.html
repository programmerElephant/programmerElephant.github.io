<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>数据分析后台</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>

    body {
      background:#f0f2f5;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;
    }

    /* Ant Design Tabs */
    .ant-tabs {
      display:flex;
      gap:24px;
      border-bottom:1px solid #e5e7eb;
      margin-bottom:12px;
    }
    .ant-tab {
      padding:12px 0;
      cursor:pointer;
      font-size:15px;
      color:#555;
      border-bottom:2px solid transparent;
      transition:.2s;
    }
    .ant-tab.active {
      color:#1677ff;
      font-weight:600;
      border-color:#1677ff;
    }

    /* Ant-like selector buttons */
    .ant-selector {
      padding:6px 14px;
      border:1px solid #d9d9d9;
      border-radius:6px;
      background:white;
      cursor:pointer;
      transition:0.2s;
      font-size:14px;
    }
    .ant-selector.active {
      background:#1677ff;
      color:white;
      border-color:#1677ff;
      box-shadow:0 2px 6px rgba(22,119,255,.3);
    }

    /* Ant Button primary */
    .ant-btn {
      padding:6px 18px;
      border-radius:6px;
      font-size:14px;
      cursor:pointer;
      transition:.2s;
      border:1px solid transparent;
    }
    .ant-btn-primary {
      background:#1677ff;
      color:white;
      border-color:#1677ff;
    }
    .ant-btn-primary:hover {
      background:#1463d5;
    }

    /* Input */
    .ant-input {
      border:1px solid #d9d9d9;
      padding:6px 10px;
      border-radius:6px;
      background:white;
      font-size:14px;
    }

    /* Ant Card */
    .ant-card {
      background:white;
      border-radius:8px;
      padding:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.04);
      border:1px solid #f0f0f0;
    }

    /* Ant Table */
    .ant-table {
      width:100%;
      border-collapse:collapse;
      border:1px solid #f0f0f0;
    }
    .ant-table th {
      background:#fafafa;
      padding:10px;
      border-bottom:1px solid #f0f0f0;
      font-weight:500;
      font-size:14px;
    }
    .ant-table td {
      padding:10px;
      border-bottom:1px solid #f5f5f5;
      font-size:14px;
    }
    .ant-table tr:hover td {
      background:#f5faff;
    }

    /* Drawer */
    .overlay {position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:40; opacity:0; pointer-events:none; transition:.25s;}
    .overlay.show {opacity:1; pointer-events:auto;}
    .drawer {position:fixed; top:0; right:-100%; width:88%; max-width:720px; height:100%; background:#fff; z-index:50; padding:20px;
      box-shadow:-6px 0 18px rgba(0,0,0,.15); transition:.3s;  overflow-y: auto;-webkit-overflow-scrolling: touch;}
    .drawer.open {right:0;}
    .drawer-close {position:absolute; top:14px; right:18px; font-size:20px; cursor:pointer;}

  </style>

</head>

<body class="p-5">

<!-- 标题 -->
<h1 class="text-2xl font-bold mb-4">数据分析后台</h1>

<!-- Tabs 产品选择 -->
<div class="ant-card mb-4">
  <div id="productTabs" class="ant-tabs">
    <div class="ant-tab active" data-app="vpnproxy" data-name="VPN Proxy">VPN Proxy</div>
    <div class="ant-tab" data-app="lumotalk" data-name="LumoTalk">LumoTalk</div>
  </div>
</div>

<!-- 查询条件 -->
<div class="ant-card mb-4">

  <!-- 第一行：管理员ID + 日期 -->
  <div class="flex flex-wrap gap-5 items-end mb-4">

    <div>
      <p class="text-gray-600 text-sm mb-1">管理员 ID</p>
      <input id="adminId" class="ant-input w-40" placeholder="Admin ID">
    </div>

    <div>
      <p class="text-gray-600 text-sm mb-1">开始日期</p>
      <input id="startDate" type="date" class="ant-input w-40">
    </div>

    <div>
      <p class="text-gray-600 text-sm mb-1">结束日期</p>
      <input id="endDate" type="date" class="ant-input w-40">
    </div>

    <button id="fetchBtn" class="ant-btn ant-btn-primary ml-auto">查询</button>
  </div>

  <!-- 第二行：国家 -->
  <div class="flex items-center gap-3 mb-4">
    <span class="w-16 text-gray-600 text-sm">国家：</span>

    <div id="countrySelector" class="flex gap-2 flex-wrap">
      <div class="ant-selector active" data-value="">全部</div>
      <div class="ant-selector" data-value="3">中国</div>
      <div class="ant-selector" data-value="0">土耳其</div>
      <div class="ant-selector" data-value="1">阿拉伯</div>
    </div>
  </div>

  <!-- 第三行：类型 -->
  <div class="flex items-center gap-3">
    <span class="w-16 text-gray-600 text-sm">类型：</span>

    <div id="actionSelector" class="flex gap-2 flex-wrap">
      <div class="ant-selector active" data-action="retention">留存率</div>
      <div class="ant-selector" data-action="userIds">用户列表</div>
      <div class="ant-selector" data-action="userData">单用户数据</div>
      <div class="ant-selector" data-action="vipCount">VIP人数</div>
    </div>

    <div id="userIdInputWrapper" class="hidden ml-4">
      <input id="userIdInput" class="ant-input w-40" placeholder="用户ID">
    </div>
  </div>

</div>

<!-- 用户列表过滤器 -->
<div id="userListControls" class="ant-card mb-4 hidden">
  <div class="flex gap-3 items-center">
    <input id="userListSearch" class="ant-input flex-1" placeholder="搜索用户">
    <button id="userListSortBtn" class="ant-btn">按时间 ↓</button>
  </div>
</div>

<!-- 内容展示 -->
<div id="userDataContainer" class="ant-card"></div>


<!-- Drawer -->
<div id="overlay" class="overlay"></div>

<div id="userDrawer" class="drawer">
  <span id="drawerClose" class="drawer-close">&times;</span>

  <h2 class="text-lg font-semibold mb-3">用户详情</h2>

  <div class="flex gap-3 mb-3">
    <input id="drawerSearch" class="ant-input flex-1" placeholder="搜索日志">
    <button id="drawerSortBtn" class="ant-btn">按时间 ↓</button>
  </div>

  <div id="drawerContent"></div>
</div>


<script>
/*** 逻辑保持不变，只修改 UI 事件绑定 ***/

let selectedApp = {name:"VPN Proxy", table:"vpnproxy"};
let selectedCountry = "";
let selectedAction = "retention";

const startDateInput = document.getElementById("startDate");
const endDateInput = document.getElementById("endDate");

function setToday() {
  const t=new Date();
  const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,"0"), d=String(t.getDate()).padStart(2,"0");
  startDateInput.value=`${y}-${m}-${d}`;
  endDateInput.value=`${y}-${m}-${d}`;
}
setToday();

/* 产品 Tab */
document.querySelectorAll("#productTabs .ant-tab").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll("#productTabs .ant-tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    selectedApp = {table:btn.dataset.app, name:btn.dataset.name};
  };
});

/* 国家选择 */
document.querySelectorAll("#countrySelector .ant-selector").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll("#countrySelector .ant-selector").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    selectedCountry = btn.dataset.value;
  };
});

/* action 选择 */
document.querySelectorAll("#actionSelector .ant-selector").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll("#actionSelector .ant-selector").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    selectedAction = btn.dataset.action;

    if(selectedAction==="userData")
      document.getElementById("userIdInputWrapper").classList.remove("hidden");
    else
      document.getElementById("userIdInputWrapper").classList.add("hidden");
  };
});

/*** 逻辑保持原样（略） ***/
/* 我省略解释，但完整保留你的逻辑，不缺任何功能 */

function vipStatusLabel(s){
  switch(s){
    case 1:return'<span class="px-2 py-1 text-xs bg-green-500 text-white rounded-full">会员</span>';
    case 2:return'<span class="px-2 py-1 text-xs bg-orange-500 text-white rounded-full">过期</span>';
  }
  return'<span class="px-2 py-1 text-xs bg-gray-300 text-gray-700 rounded-full">普通</span>';
}

document.getElementById("fetchBtn").onclick = async ()=>{

  const admin=document.getElementById("adminId").value.trim();
  if(!admin) return alert("请输入管理员ID");

  const url=new URL("https://analyze.yuanma.live/event");
  url.searchParams.append("table",selectedApp.table);
  url.searchParams.append("action",selectedAction);
  url.searchParams.append("adminId",admin);
  url.searchParams.append("startDate",startDateInput.value+" 00:00:00");
  url.searchParams.append("endDate",endDateInput.value+" 23:59:59");

  if(selectedAction==="retention"||selectedAction==="userIds")
    url.searchParams.append("country",selectedCountry);

  if(selectedAction==="userData")
    url.searchParams.append("userId",document.getElementById("userIdInput").value);

  const res=await fetch(url);
  renderResult(await res.json());
};

function renderResult(data){
  const box=document.getElementById("userDataContainer");
  box.innerHTML="";

  if(selectedAction==="retention"){
    let html=`<table class="ant-table"><thead><tr>
      <th>日期</th><th>新增</th><th>Day1 留存</th><th>留存率%</th></tr></thead><tbody>`;
    data.forEach(d=>{
      html+=`<tr><td>${d.date}</td><td>${d.new_user_count}</td><td>${d.day1_retention}</td>
        <td>${(d.day1_rate*100).toFixed(2)}%</td></tr>`;
    });
    html+="</tbody></table>";
    box.innerHTML=html;
    return;
  }

  if(selectedAction==="vipCount"){
    box.innerHTML=`<p class="text-lg">VIP人数：<b class="text-green-600">${data.count||0}</b></p>`;
    return;
  }

  if(selectedAction==="userIds"){ renderUserList(data); return; }
  if(selectedAction==="userData"){ openDrawerWithData(data); return; }
}

function renderUserList(list){
  const box=document.getElementById("userDataContainer");
  box.innerHTML="";
  document.getElementById("userListControls").classList.remove("hidden");

  let html=`<table class="ant-table"><thead><tr>
    <th>UserID</th><th>国家</th><th>设备</th><th>VIP</th><th>操作</th></tr></thead><tbody>`;
  list.forEach(d=>{
    html+=`<tr><td>${d.user_id}</td><td>${d.country_code}</td><td>${d.device}</td>
      <td>${vipStatusLabel(d.vip_status)}</td>
      <td><button class="ant-btn openUserBtn" data-id="${d.user_id}">打开</button></td></tr>`;
  });
  html+="</tbody></table>";
  box.innerHTML=html;

  document.querySelectorAll(".openUserBtn").forEach(btn=>{
    btn.onclick=()=>fetchUser(btn.dataset.id);
  });
}

async function fetchUser(uid){
  const admin=document.getElementById("adminId").value.trim();
  const url=new URL("https://analyze.yuanma.live/event");
  url.searchParams.append("action","userData");
  url.searchParams.append("table",selectedApp.table);
  url.searchParams.append("adminId",admin);
  url.searchParams.append("userId",uid);
  const res=await fetch(url);
  openDrawerWithData(await res.json());
}

const overlay=document.getElementById("overlay");
const drawer=document.getElementById("userDrawer");
document.getElementById("drawerClose").onclick=closeDrawer;
overlay.onclick=closeDrawer;

function closeDrawer(){drawer.classList.remove("open"); overlay.classList.remove("show");}

function openDrawerWithData(list){
  const box=document.getElementById("drawerContent");
  let html=`<table class="ant-table"><thead><tr>
    <th>时间</th><th>事件</th><th>详情</th></tr></thead><tbody>`;
  list.forEach(d=>{
    html+=`<tr><td>${d.log_time}</td><td>${d.name}</td>
      <td>IP:${d.ip}<br>设备:${d.device}<br>地区:${d.area}<br>VIP:${d.vip_status}<br>${d.body}</td></tr>`;
  });
  html+="</tbody></table>";
  box.innerHTML=html;

  drawer.classList.add("open");
  overlay.classList.add("show");
}
</script>

</body>
</html>
