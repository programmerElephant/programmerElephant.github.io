<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>数据分析后台</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>
    body {
      background:#f0f2f5;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;
    }

    /* Ant Design Tabs */
    .ant-tabs {
      display:flex;
      gap:24px;
      border-bottom:1px solid #e5e7eb;
      margin-bottom:12px;
    }
    .ant-tab {
      padding:12px 0;
      cursor:pointer;
      font-size:15px;
      color:#555;
      border-bottom:2px solid transparent;
      transition:.2s;
    }
    .ant-tab.active {
      color:#1677ff;
      font-weight:600;
      border-color:#1677ff;
    }

    /* Ant-like selector buttons */
    .ant-selector {
      padding:6px 14px;
      border:1px solid #d9d9d9;
      border-radius:6px;
      background:white;
      cursor:pointer;
      transition:0.2s;
      font-size:14px;
    }
    .ant-selector.active {
      background:#1677ff;
      color:white;
      border-color:#1677ff;
      box-shadow:0 2px 6px rgba(22,119,255,.3);
    }

    /* Ant Button primary */
    .ant-btn {
      padding:6px 18px;
      border-radius:6px;
      font-size:14px;
      cursor:pointer;
      transition:.2s;
      border:1px solid transparent;
    }
    .ant-btn-primary {
      background:#1677ff;
      color:white;
      border-color:#1677ff;
    }
    .ant-btn-primary:hover {
      background:#1463d5;
    }

    /* Input */
    .ant-input {
      border:1px solid #d9d9d9;
      padding:6px 10px;
      border-radius:6px;
      background:white;
      font-size:14px;
    }

    /* Ant Card */
    .ant-card {
      background:white;
      border-radius:8px;
      padding:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.04);
      border:1px solid #f0f0f0;
    }

    /* Ant Table */
    .ant-table {
      width:100%;
      border-collapse:collapse;
      border:1px solid #f0f0f0;
    }
    .ant-table th {
      background:#fafafa;
      padding:10px;
      border-bottom:1px solid #f0f0f0;
      font-weight:500;
      font-size:14px;
      text-align: center;
    }
    .ant-table td {
      padding:10px;
      border-bottom:1px solid #f5f5f5;
      font-size:14px;
      text-align: center;
    }
    .ant-table td:nth-child(1) {
        text-align: left;
    }
    .ant-table tr:hover td {
      background:#f5faff;
    }

    /* Drawer */
    .overlay {position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:40; opacity:0; pointer-events:none; transition:.25s;}
    .overlay.show {opacity:1; pointer-events:auto;}
    .drawer {position:fixed; top:0; right:-100%; width:88%; max-width:720px; height:100%; background:#fff; z-index:50; padding:20px;
      box-shadow:-6px 0 18px rgba(0,0,0,.15); transition:.3s;  overflow-y: auto;-webkit-overflow-scrolling: touch;}
    .drawer.open {right:0;}
    .drawer-close {position:absolute; top:14px; right:18px; font-size:20px; cursor:pointer;}

    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,.04);
        border: 1px solid #f0f0f0;
        cursor: pointer;
        transition: transform 0.1s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,.06);
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #1677ff;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
    }
  </style>
</head>

<body class="p-5">

<h1 class="text-2xl font-bold mb-4">数据分析后台</h1>

<div class="ant-card mb-4">
  <div id="productTabs" class="ant-tabs">
    <div class="ant-tab active" data-app="vpnproxy" data-name="VPN Proxy">VPN Proxy</div>
    <div class="ant-tab" data-app="lumotalk" data-name="LumoTalk">LumoTalk</div>
  </div>
</div>

<div class="ant-card mb-4">
  <div class="flex flex-wrap gap-5 items-end mb-4">
    <div>
      <p class="text-gray-600 text-sm mb-1">管理员 ID</p>
      <input id="adminId" class="ant-input w-40" placeholder="Admin ID" value="chaman">
    </div>

    <div>
      <p class="text-gray-600 text-sm mb-1">开始日期</p>
      <input id="startDate" type="date" class="ant-input w-40">
    </div>

    <div>
      <p class="text-gray-600 text-sm mb-1">结束日期</p>
      <input id="endDate" type="date" class="ant-input w-40">
    </div>

    <button id="fetchBtn" class="ant-btn ant-btn-primary ml-auto">查询</button>
  </div>

  <div class="flex items-center gap-3 mb-4">
    <span class="w-16 text-gray-600 text-sm">国家：</span>
    <div id="countrySelector" class="flex gap-2 flex-wrap">
      <div class="ant-selector active" data-value="">加载中...</div>
    </div>
  </div>

  <div class="flex items-center gap-3">
    <span class="w-16 text-gray-600 text-sm">类型：</span>
    <div id="actionSelector" class="flex gap-2 flex-wrap">
      <div class="ant-selector" data-action="retention">留存率</div>
      <div class="ant-selector active" data-action="userIds">用户列表</div>
      <div class="ant-selector" data-action="userData">单用户数据</div>
      <div class="ant-selector" data-action="vipCount">VIP人数</div>
    </div>
    <div id="userIdInputWrapper" class="hidden ml-4">
      <input id="userIdInput" class="ant-input w-40" placeholder="用户ID">
    </div>
  </div>
</div>

<div id="statsContainer" class="mb-4 hidden">
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div id="statNewUsers" class="stat-card" data-action="install" data-label="新用户列表">
      <div class="stat-value text-blue-500" id="statNewUsersValue">0</div>
      <div class="stat-label">新用户数</div>
      <div class="text-xs text-gray-500 mt-1">购买率: <span id="rateBuy">0.00%</span></div>
    </div>
    <div id="statPurchases" class="stat-card" data-action="buy" data-label="购买用户列表">
      <div class="stat-value text-green-500" id="statPurchasesValue">0</div>
      <div class="stat-label">购买人数</div>
    </div>
    <div id="statCancellations" class="stat-card" data-action="cancel" data-label="取消用户列表">
      <div class="stat-value text-orange-500" id="statCancellationsValue">0</div>
      <div class="stat-label">订单取消人数</div>
      <div class="text-xs text-gray-500 mt-1">取消率: <span id="rateCancel">0.00%</span></div>
    </div>
    <div id="statRefunds" class="stat-card" data-action="refund" data-label="退款用户列表">
      <div class="stat-value text-red-500" id="statRefundsValue">0</div>
      <div class="stat-label">退款人数</div>
      <div class="text-xs text-gray-500 mt-1">退款率: <span id="rateRefund">0.00%</span></div>
    </div>
  </div>
</div>

<div id="userListControls" class="ant-card mb-4 hidden">
  <div class="flex gap-3 items-center">
    <input id="userListSearch" class="ant-input flex-1" placeholder="搜索用户ID、国家或设备">
    <button id="userListSortBtn" class="ant-btn" data-sort-field="log_time" data-sort-order="desc">按时间 ↓</button>
  </div>
</div>

<div id="userDataContainer" class="ant-card"></div>
<div id="overlay" class="overlay"></div>
<div id="userDrawer" class="drawer">
  <span id="drawerClose" class="drawer-close">&times;</span>
  <h2 class="text-lg font-semibold mb-3" id="drawerTitle">用户详情</h2>
  <div id="drawerControls" class="flex gap-3 mb-3">
    <input id="drawerSearch" class="ant-input flex-1" placeholder="搜索事件名称、IP、设备或Body内容">
    <button id="drawerSortBtn" class="ant-btn">按时间 ↓</button>
  </div>
  <div id="drawerContent"></div>
</div>

<script>
// --- 国家名称映射表 ---
const countryNameMap = {
  // ===== 亚洲 =====
  "CN": "中国",
  "HK": "中国香港",
  "TW": "中国台湾",
  "MO": "中国澳门",
  "JP": "日本",
  "KR": "韩国",
  "KP": "朝鲜",
  "IN": "印度",
  "PK": "巴基斯坦",
  "BD": "孟加拉国",
  "LK": "斯里兰卡",
  "NP": "尼泊尔",
  "BT": "不丹",
  "MM": "缅甸",
  "TH": "泰国",
  "VN": "越南",
  "LA": "老挝",
  "KH": "柬埔寨",
  "MY": "马来西亚",
  "SG": "新加坡",
  "ID": "印尼",
  "PH": "菲律宾",
  "BN": "文莱",
  "MN": "蒙古",
  "KZ": "哈萨克斯坦",
  "UZ": "乌兹别克斯坦",
  "TM": "土库曼斯坦",
  "KG": "吉尔吉斯斯坦",
  "TJ": "塔吉克斯坦",

  // ===== 中东 =====
  "TR": "土耳其",
  "SA": "沙特阿拉伯",
  "AE": "阿联酋",
  "IR": "伊朗",
  "IQ": "伊拉克",
  "IL": "以色列",
  "JO": "约旦",
  "LB": "黎巴嫩",
  "SY": "叙利亚",
  "KW": "科威特",
  "QA": "卡塔尔",
  "BH": "巴林",
  "OM": "阿曼",
  "YE": "也门",

  // ===== 欧洲 =====
  "GB": "英国",
  "IE": "爱尔兰",
  "FR": "法国",
  "DE": "德国",
  "IT": "意大利",
  "ES": "西班牙",
  "PT": "葡萄牙",
  "NL": "荷兰",
  "BE": "比利时",
  "LU": "卢森堡",
  "CH": "瑞士",
  "AT": "奥地利",
  "SE": "瑞典",
  "NO": "挪威",
  "DK": "丹麦",
  "FI": "芬兰",
  "IS": "冰岛",
  "PL": "波兰",
  "CZ": "捷克",
  "SK": "斯洛伐克",
  "HU": "匈牙利",
  "RO": "罗马尼亚",
  "BG": "保加利亚",
  "GR": "希腊",
  "HR": "克罗地亚",
  "SI": "斯洛文尼亚",
  "RS": "塞尔维亚",
  "BA": "波黑",
  "ME": "黑山",
  "MK": "北马其顿",
  "AL": "阿尔巴尼亚",
  "UA": "乌克兰",
  "BY": "白俄罗斯",
  "LT": "立陶宛",
  "LV": "拉脱维亚",
  "EE": "爱沙尼亚",

  // ===== 北美 =====
  "US": "美国",
  "CA": "加拿大",
  "MX": "墨西哥",

  // ===== 南美 =====
  "BR": "巴西",
  "AR": "阿根廷",
  "CL": "智利",
  "CO": "哥伦比亚",
  "PE": "秘鲁",
  "VE": "委内瑞拉",
  "EC": "厄瓜多尔",
  "BO": "玻利维亚",
  "PY": "巴拉圭",
  "UY": "乌拉圭",

  // ===== 非洲 =====
  "EG": "埃及",
  "ZA": "南非",
  "NG": "尼日利亚",
  "KE": "肯尼亚",
  "ET": "埃塞俄比亚",
  "TZ": "坦桑尼亚",
  "UG": "乌干达",
  "GH": "加纳",
  "CI": "科特迪瓦",
  "SN": "塞内加尔",
  "DZ": "阿尔及利亚",
  "MA": "摩洛哥",
  "TN": "突尼斯",
  "LY": "利比亚",
  "SD": "苏丹",

  // ===== 大洋洲 =====
  "AU": "澳大利亚",
  "NZ": "新西兰",
  "PG": "巴布亚新几内亚",
  "FJ": "斐济",
  "SB": "所罗门群岛",

  // ===== 其他 / 常见特殊 =====
  "RU": "俄罗斯",
  "AF": "阿富汗",
  "AM": "亚美尼亚",
  "AZ": "阿塞拜疆",
  "GE": "格鲁吉亚",
  "MD": "摩尔多瓦"
};


let selectedApp = {name:"VPN Proxy", table:"vpnproxy"};
let selectedCountry = "";
let selectedAction = "userIds";

let userStats = { install: [], buy: [], cancel: [], refund: [], userIds: [] };
let currentAllUserList = [];
let currentDisplayedUserList = [];
let currentDrawerData = [];
let sortOrder = 'desc';

const startDateInput = document.getElementById("startDate");
const endDateInput = document.getElementById("endDate");
const userListSearchInput = document.getElementById("userListSearch");
const userListSortBtn = document.getElementById("userListSortBtn");
const drawerSortBtn = document.getElementById("drawerSortBtn");
const drawerSearchInput = document.getElementById("drawerSearch");

// --- 自动获取国家接口并渲染 ---
async function initCountries() {
    const url = "https://analyze.yuanma.live/event?&action=countries&adminId=chaman&table=lumotalk";
    const selectorContainer = document.getElementById("countrySelector");
    
    try {
        const response = await fetch(url);
        const res = await response.json();
        
        if (res.success && res.data) {
            // 渲染“全部” + 接口返回的国家
            renderCountrySelectors(res.data);
        } else {
            selectorContainer.innerHTML = '<div class="ant-selector active" data-value="">全部</div>';
        }
    } catch (e) {
        console.error("获取国家列表失败", e);
        selectorContainer.innerHTML = '<div class="ant-selector active" data-value="">全部</div>';
    }
}

function renderCountrySelectors(countries) {
    const container = document.getElementById("countrySelector");
    // 1. 手动添加全部
    let html = `<div class="ant-selector active" data-value="">全部</div>`;
    
    // 2. 遍历接口数据
    countries.forEach(code => {
        const name = countryNameMap[code] || code; // 如果找不到对应名称，则显示代码本身
        html += `<div class="ant-selector" data-value="${code}">${name}</div>`;
    });
    
    container.innerHTML = html;

    // 3. 重新绑定点击事件
    container.querySelectorAll(".ant-selector").forEach(btn => {
        btn.onclick = () => {
            container.querySelectorAll(".ant-selector").forEach(b => b.classList.remove("active"));
            btn.classList.add("active");
            selectedCountry = btn.dataset.value;
            console.log("当前选择国家:", selectedCountry);
        };
    });
}

// 页面加载运行
window.onload = function() {
    setToday();
    initCountries();
};

function getAdjustedDateRange(startDateStr, endDateStr, country) {
    const formatDateTime = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    };

    let start = new Date(startDateStr);
    let end = new Date(endDateStr);
    
    console.log("调整时间国家为",country)
    
    // 这里的逻辑对应你要求的 TR(土耳其) 等代码转换逻辑
    // 0 是土耳其旧代码，TR 是新代码
    if (country === "0" || country === "1" || country === "TR" || country === "SA") {
        start.setHours(5, 0, 0, 0);
        end.setHours(0, 0, 0, 0);
        end.setDate(end.getDate() + 1);
        end.setHours(4, 59, 59, 0);
    } else {
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 0);
    }

    return {
        startDateTime: formatDateTime(start),
        endDateTime: formatDateTime(end)
    };
}

function setToday() {
  const t=new Date();
  const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,"0"), d=String(t.getDate()).padStart(2,"0");
  startDateInput.value=`${y}-${m}-${d}`;
  endDateInput.value=`${y}-${m}-${d}`;
}

/* 产品 Tab */
document.querySelectorAll("#productTabs .ant-tab").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll("#productTabs .ant-tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    selectedApp = {table:btn.dataset.app, name:btn.dataset.name};
  };
});

/* action 选择 */
document.querySelectorAll("#actionSelector .ant-selector").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll("#actionSelector .ant-selector").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    selectedAction = btn.dataset.action;

    if(selectedAction==="userIds"){
      document.getElementById("statsContainer").classList.remove("hidden");
      document.getElementById("userListControls").classList.remove("hidden");
    } else {
      document.getElementById("statsContainer").classList.add("hidden");
      document.getElementById("userListControls").classList.add("hidden");
    }

    if(selectedAction==="userData")
      document.getElementById("userIdInputWrapper").classList.remove("hidden");
    else
      document.getElementById("userIdInputWrapper").classList.add("hidden");
  };
});

document.querySelector('#actionSelector .ant-selector[data-action="userIds"]').click();

function vipStatusLabel(s){
  switch(s){
    case 1:return'<span class="px-2 py-1 text-xs bg-green-500 text-white rounded-full">会员</span>';
    case 2:return'<span class="px-2 py-1 text-xs bg-orange-500 text-white rounded-full">过期</span>';
  }
  return'<span class="px-2 py-1 text-xs bg-gray-300 text-gray-700 rounded-full">普通</span>';
}

document.querySelectorAll('#statsContainer .stat-card').forEach(card => {
    card.onclick = () => {
        const action = card.dataset.action;
        const label = card.dataset.label;
        const list = userStats[action];
        if (list && list.length > 0) {
            openDrawerWithUserIds(list, label);
        } else {
            alert(`当前没有 ${label}`);
        }
    };
});

document.getElementById("fetchBtn").onclick = async ()=>{
  const admin=document.getElementById("adminId").value.trim();
  if(!admin) return alert("请输入管理员ID");
  if (!startDateInput.value || !endDateInput.value) return alert("请选择日期");

  const { startDateTime, endDateTime } = getAdjustedDateRange(startDateInput.value, endDateInput.value, selectedCountry);
  
  if(selectedAction==="userIds"){
      await fetchStats(admin, startDateTime, endDateTime);
      currentAllUserList = userStats.userIds;
      applyUserListFilterAndSort();
      return;
  }
  
  if(selectedAction==="userData" && !document.getElementById("userIdInput").value) {
      return alert("请输入用户ID");
  }

  const url=new URL("https://analyze.yuanma.live/event");
  url.searchParams.append("table",selectedApp.table);
  url.searchParams.append("action",selectedAction);
  url.searchParams.append("adminId",admin);
  url.searchParams.append("startDate", startDateTime);
  url.searchParams.append("endDate", endDateTime);

  if(selectedAction==="retention"||selectedAction==="userIds")
    url.searchParams.append("country",selectedCountry);

  if(selectedAction==="userData")
    url.searchParams.append("userId",document.getElementById("userIdInput").value);

  try {
      const res=await fetch(url);
      if(!res.ok) throw new Error(res.statusText);
      renderResult(await res.json());
  } catch(error) {
      alert(`查询失败: ${error.message}`);
  }
};

async function fetchStats(adminId, startDateTime, endDateTime) {
    const actionMap = {
        "install": "install",
        "buy": "subscribe_page_success,guide_start_success",
        "cancel": "cancel",
        "refund": "refund",
        "userIds": null
    };
    const actions = Object.keys(actionMap);
    const country = selectedCountry;
    const table = selectedApp.table;

    const promises = actions.map(action => {
        const url = new URL("https://analyze.yuanma.live/event");
        url.searchParams.append("table", table);
        url.searchParams.append("action", action);
        url.searchParams.append("adminId", adminId);
        url.searchParams.append("startDate", startDateTime);
        url.searchParams.append("endDate", endDateTime);
        
        if(action !== 'userData') {
          url.searchParams.append("country", country);
        }

        if(actionMap[action]) {
             url.searchParams.append("name", actionMap[action]);
        }

        return fetch(url).then(res => res.json()).then(data => ({ action, data }))
          .catch(error => ({ action, data: [] }));
    });

    const results = await Promise.all(promises);
    results.forEach(item => { userStats[item.action] = item.data; });
    updateStatsDisplay();
}

function updateStatsDisplay() {
    const installCount = userStats.install.length;
    const buyCount = userStats.buy.length;
    const cancelCount = userStats.cancel.length;
    const refundCount = userStats.refund.length;
    const userCount = userStats.userIds.length;

    document.getElementById("statNewUsersValue").textContent = `${installCount}/${userCount}`;
    document.getElementById("statPurchasesValue").textContent = buyCount;
    document.getElementById("statCancellationsValue").textContent = cancelCount;
    document.getElementById("statRefundsValue").textContent = refundCount;

    const rateBuy = installCount > 0 ? (buyCount / installCount * 100).toFixed(2) : "0.00";
    const rateCancel = buyCount > 0 ? (cancelCount / buyCount * 100).toFixed(2) : "0.00";
    const rateRefund = buyCount > 0 ? (refundCount / buyCount * 100).toFixed(2) : "0.00";

    document.getElementById("rateBuy").textContent = `${rateBuy}%`;
    document.getElementById("rateCancel").textContent = `${rateCancel}%`;
    document.getElementById("rateRefund").textContent = `${rateRefund}%`;
}

function renderResult(data){
  const box=document.getElementById("userDataContainer");
  box.innerHTML="";

  if(selectedAction==="retention"){
    let html=`<table class="ant-table"><thead><tr>
      <th>日期</th><th>新增</th><th>Day1 留存</th><th>留存率%</th></tr></thead><tbody>`;
    data.forEach(d=>{
      const date = d.period_start ? d.period_start.substring(0, 10) : '未知日期';
      html+=`<tr><td>${date}</td><td>${d.new_user_count}</td><td>${d.day1_retention}</td>
        <td>${(d.day1_rate*100).toFixed(2)}%</td></tr>`;
    });
    html+="</tbody></table>";
    box.innerHTML=html;
    return;
  }

  if(selectedAction==="vipCount"){
    box.innerHTML=`<p class="text-lg">VIP人数：<b class="text-green-600">${data.count||0}</b></p>`;
    return;
  }

  if(selectedAction==="userIds"){
    currentAllUserList = data;
    applyUserListFilterAndSort();
    return;
  }
  
  if(selectedAction==="userData"){ openDrawerWithData(data); return; }
}

function applyUserListFilterAndSort() {
    let filteredList = currentAllUserList;
    const searchText = userListSearchInput.value.toLowerCase().trim();
    const sortField = userListSortBtn.dataset.sortField;
    const sortOrder = userListSortBtn.dataset.sortOrder;

    if (searchText) {
        filteredList = currentAllUserList.filter(d => {
            return d.user_id.toLowerCase().includes(searchText) ||
                   d.country_code.toLowerCase().includes(searchText) ||
                   d.device.toLowerCase().includes(searchText);
        });
    }

    filteredList.sort((a, b) => {
        let valA, valB;
        if (sortField === 'log_time') {
            valA = new Date(a.log_time); valB = new Date(b.log_time);
        } else if (sortField === 'vip_status') {
            valA = a.vip_status; valB = b.vip_status;
        } else {
            valA = a[sortField] || ''; valB = b[sortField] || '';
        }
        if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
        if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
        return 0;
    });

    currentDisplayedUserList = filteredList;
    renderUserList(currentDisplayedUserList);
}

userListSortBtn.onclick = () => {
    let currentField = userListSortBtn.dataset.sortField;
    let currentOrder = userListSortBtn.dataset.sortOrder;
    let newField, newOrder;

    if (currentField === 'log_time') {
        newField = 'vip_status'; newOrder = 'desc';
    } else {
        newField = 'log_time'; newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
    }

    userListSortBtn.dataset.sortField = newField;
    userListSortBtn.dataset.sortOrder = newOrder;
    const orderIcon = newOrder === 'desc' ? '↓' : '↑';
    let fieldText = newField === 'log_time' ? '时间' : 'VIP';
    userListSortBtn.textContent = `按${fieldText} ${orderIcon}`;
    applyUserListFilterAndSort();
};

userListSearchInput.oninput = applyUserListFilterAndSort;

function renderUserList(list){
  const box=document.getElementById("userDataContainer");
  box.innerHTML="";
  let html=`<table class="ant-table"><thead><tr>
    <th>UserID</th><th>国家</th><th>设备</th><th>VIP</th><th>最后记录时间</th><th>操作</th></tr></thead><tbody>`;
  list.forEach(d=>{
    html+=`<tr><td>${d.user_id}</td><td>${d.country_code}</td><td>${d.device}</td>
      <td>${vipStatusLabel(d.vip_status)}</td>
      <td>${d.log_time}</td>
      <td><button class="ant-btn openUserBtn" data-id="${d.user_id}">打开</button></td></tr>`;
  });
  html+="</tbody></table>";
  box.innerHTML=html;

  document.querySelectorAll(".openUserBtn").forEach(btn=>{
    btn.onclick=()=>fetchUser(btn.dataset.id);
  });
}

async function fetchUser(uid){
  const admin=document.getElementById("adminId").value.trim();
  const url=new URL("https://analyze.yuanma.live/event");
  url.searchParams.append("action","userData");
  url.searchParams.append("table",selectedApp.table);
  url.searchParams.append("adminId",admin);
  url.searchParams.append("userId",uid);
  try {
      const res=await fetch(url);
      openDrawerWithData(await res.json());
  } catch(error) { alert(`详情失败: ${error.message}`); }
}

const overlay=document.getElementById("overlay");
const drawer=document.getElementById("userDrawer");
document.getElementById("drawerClose").onclick=closeDrawer;
overlay.onclick=closeDrawer;
drawerSortBtn.onclick = sortDrawerData;
drawerSearchInput.oninput = applyDrawerSearch;

function closeDrawer(){
    drawer.classList.remove("open");
    overlay.classList.remove("show");
}

function applyDrawerSearch() {
    const searchText = drawerSearchInput.value.toLowerCase().trim();
    if (!searchText) { sortDrawerData(true); return; }
    const filteredList = currentDrawerData.filter(d => {
        const bodyContent = formatBodyContent(d.body);
        return d.name.toLowerCase().includes(searchText) ||
               d.ip.toLowerCase().includes(searchText) ||
               d.device.toLowerCase().includes(searchText) ||
               bodyContent.toLowerCase().includes(searchText);
    });
    renderDrawerContent(filteredList);
}

function sortDrawerData(reset = false) {
    if (currentDrawerData.length === 0) return;
    if (!reset) sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
    else sortOrder = 'desc';
    
    drawerSearchInput.value = '';
    currentDrawerData.sort((a, b) => {
        const dateA = new Date(a.log_time);
        const dateB = new Date(b.log_time);
        return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
    });
    drawerSortBtn.textContent = sortOrder === 'desc' ? '按时间 ↓' : '按时间 ↑';
    renderDrawerContent(currentDrawerData);
}

function formatBodyContent(body) {
    if (!body) return '';
    return body.split('|').filter(item => item.trim() !== '')
               .map(item => `<div class="text-xs text-gray-700">${item.trim()}</div>`).join('');
}

function renderDrawerContent(list) {
    const box = document.getElementById("drawerContent");
    let html=`<table class="ant-table"><thead><tr>
        <th style="text-align: left;">时间</th><th style="text-align: center;">事件</th><th style="text-align: left;">详情</th></tr></thead><tbody>`;
    list.forEach(d=>{
        const detailHtml = `
            <div class="text-left text-xs space-y-1">
                <div><span class="font-semibold">IP:</span> ${d.ip}</div>
                <div><span class="font-semibold">设备:</span> ${d.device}</div>
                <div><span class="font-semibold">地区:</span> ${d.area}</div>
                <div><span class="font-semibold">VPN:</span> ${d.vpn_status === 1 ? '开启' : '关闭'}</div>
                ${d.body ? `<div><span class="font-semibold">Body:</span> ${formatBodyContent(d.body)}</div>` : ''}
            </div>`;
        html+=`<tr><td style="text-align: left;">${d.log_time}</td><td style="text-align: center;">${d.name}</td><td style="text-align: left;">${detailHtml}</td></tr>`;
    });
    html+="</tbody></table>";
    box.innerHTML=html;
}

function openDrawerWithData(list){
    document.getElementById("drawerTitle").textContent = "用户详情";
    document.getElementById("drawerControls").classList.remove("hidden");
    currentDrawerData = list;
    drawerSearchInput.value = '';
    sortOrder = 'desc';
    currentDrawerData.sort((a, b) => new Date(b.log_time) - new Date(a.log_time));
    renderDrawerContent(currentDrawerData);
    drawer.classList.add("open");
    overlay.classList.add("show");
}

function openDrawerWithUserIds(list, title) {
    document.getElementById("drawerTitle").textContent = title;
    document.getElementById("drawerControls").classList.add("hidden");
    const box = document.getElementById("drawerContent");
    let html = `<table class="ant-table"><thead><tr><th>UserID</th><th>国家</th><th>最后时间</th></tr></thead><tbody>`;
    list.forEach(d => {
        html += `<tr><td>${d.user_id}</td><td>${d.country_code}</td><td>${d.log_time}</td></tr>`;
    });
    html += "</tbody></table>";
    box.innerHTML = html;
    drawer.classList.add("open");
    overlay.classList.add("show");
}
</script>

</body>
</html>
