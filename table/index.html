<!DOCTYPE html>
<html lang="zh">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>æ•°æ®åˆ†æåå°</title>
  <script src="https://cdn.tailwindcss.com"></script>

  <style>

    body {
      background:#f0f2f5;
      font-family: -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",sans-serif;
    }

    /* Ant Design Tabs */
    .ant-tabs {
      display:flex;
      gap:24px;
      border-bottom:1px solid #e5e7eb;
      margin-bottom:12px;
    }
    .ant-tab {
      padding:12px 0;
      cursor:pointer;
      font-size:15px;
      color:#555;
      border-bottom:2px solid transparent;
      transition:.2s;
    }
    .ant-tab.active {
      color:#1677ff;
      font-weight:600;
      border-color:#1677ff;
    }

    /* Ant-like selector buttons */
    .ant-selector {
      padding:6px 14px;
      border:1px solid #d9d9d9;
      border-radius:6px;
      background:white;
      cursor:pointer;
      transition:0.2s;
      font-size:14px;
    }
    .ant-selector.active {
      background:#1677ff;
      color:white;
      border-color:#1677ff;
      box-shadow:0 2px 6px rgba(22,119,255,.3);
    }

    /* Ant Button primary */
    .ant-btn {
      padding:6px 18px;
      border-radius:6px;
      font-size:14px;
      cursor:pointer;
      transition:.2s;
      border:1px solid transparent;
    }
    .ant-btn-primary {
      background:#1677ff;
      color:white;
      border-color:#1677ff;
    }
    .ant-btn-primary:hover {
      background:#1463d5;
    }

    /* Input */
    .ant-input {
      border:1px solid #d9d9d9;
      padding:6px 10px;
      border-radius:6px;
      background:white;
      font-size:14px;
    }

    /* Ant Card */
    .ant-card {
      background:white;
      border-radius:8px;
      padding:16px;
      box-shadow:0 1px 3px rgba(0,0,0,.04);
      border:1px solid #f0f0f0;
    }

    /* Ant Table */
    .ant-table {
      width:100%;
      border-collapse:collapse;
      border:1px solid #f0f0f0;
    }
    /* ğŸŒŸ ä¼˜åŒ–5: æ ‡é¢˜å±…ä¸­å¯¹é½ */
    .ant-table th {
      background:#fafafa;
      padding:10px;
      border-bottom:1px solid #f0f0f0;
      font-weight:500;
      font-size:14px;
      text-align: center; /* æ ‡é¢˜å±…ä¸­ */
    }
    /* ğŸŒŸ ä¼˜åŒ–5: å†…å®¹å±…ä¸­å¯¹é½ */
    .ant-table td {
      padding:10px;
      border-bottom:1px solid #f5f5f5;
      font-size:14px;
      text-align: center; /* å†…å®¹å±…ä¸­ */
    }
    .ant-table td:nth-child(1) {
        text-align: left; /* UserIDæˆ–æ—¶é—´ç­‰å¯èƒ½éœ€è¦å·¦å¯¹é½ï¼Œä¿æŒå¯è¯»æ€§ */
    }
    .ant-table tr:hover td {
      background:#f5faff;
    }

    /* Drawer */
    .overlay {position:fixed; inset:0; background:rgba(0,0,0,.35); z-index:40; opacity:0; pointer-events:none; transition:.25s;}
    .overlay.show {opacity:1; pointer-events:auto;}
    .drawer {position:fixed; top:0; right:-100%; width:88%; max-width:720px; height:100%; background:#fff; z-index:50; padding:20px;
      box-shadow:-6px 0 18px rgba(0,0,0,.15); transition:.3s;  overflow-y: auto;-webkit-overflow-scrolling: touch;}
    .drawer.open {right:0;}
    .drawer-close {position:absolute; top:14px; right:18px; font-size:20px; cursor:pointer;}

    /* New Statistic Card Styling */
    .stat-card {
        background: white;
        border-radius: 8px;
        padding: 16px;
        box-shadow: 0 1px 3px rgba(0,0,0,.04);
        border: 1px solid #f0f0f0;
        cursor: pointer; /* å¯ç‚¹å‡» */
        transition: transform 0.1s;
    }
    .stat-card:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 6px rgba(0,0,0,.06);
    }
    .stat-value {
      font-size: 24px;
      font-weight: 700;
      color: #1677ff;
    }
    .stat-label {
      font-size: 14px;
      color: #666;
    }

  </style>

</head>

<body class="p-5">

<h1 class="text-2xl font-bold mb-4">æ•°æ®åˆ†æåå°</h1>

<div class="ant-card mb-4">
  <div id="productTabs" class="ant-tabs">
    <div class="ant-tab active" data-app="vpnproxy" data-name="VPN Proxy">VPN Proxy</div>
    <div class="ant-tab" data-app="lumotalk" data-name="LumoTalk">LumoTalk</div>
  </div>
</div>

<div class="ant-card mb-4">

  <div class="flex flex-wrap gap-5 items-end mb-4">

    <div>
      <p class="text-gray-600 text-sm mb-1">ç®¡ç†å‘˜ ID</p>
      <input id="adminId" class="ant-input w-40" placeholder="Admin ID">
    </div>

    <div>
      <p class="text-gray-600 text-sm mb-1">å¼€å§‹æ—¥æœŸ</p>
      <input id="startDate" type="date" class="ant-input w-40">
    </div>

    <div>
      <p class="text-gray-600 text-sm mb-1">ç»“æŸæ—¥æœŸ</p>
      <input id="endDate" type="date" class="ant-input w-40">
    </div>

    <button id="fetchBtn" class="ant-btn ant-btn-primary ml-auto">æŸ¥è¯¢</button>
  </div>

  <div class="flex items-center gap-3 mb-4">
    <span class="w-16 text-gray-600 text-sm">å›½å®¶ï¼š</span>

    <div id="countrySelector" class="flex gap-2 flex-wrap">
      <div class="ant-selector active" data-value="">å…¨éƒ¨</div>
      <div class="ant-selector" data-value="3">ä¸­å›½</div>
      <div class="ant-selector" data-value="0">åœŸè€³å…¶</div>
      <div class="ant-selector" data-value="1">é˜¿æ‹‰ä¼¯</div>
    </div>
  </div>

  <div class="flex items-center gap-3">
    <span class="w-16 text-gray-600 text-sm">ç±»å‹ï¼š</span>

    <div id="actionSelector" class="flex gap-2 flex-wrap">
      <div class="ant-selector" data-action="retention">ç•™å­˜ç‡</div>
      <div class="ant-selector active" data-action="userIds">ç”¨æˆ·åˆ—è¡¨</div>
      <div class="ant-selector" data-action="userData">å•ç”¨æˆ·æ•°æ®</div>
      <div class="ant-selector" data-action="vipCount">VIPäººæ•°</div>
    </div>

    <div id="userIdInputWrapper" class="hidden ml-4">
      <input id="userIdInput" class="ant-input w-40" placeholder="ç”¨æˆ·ID">
    </div>
  </div>

</div>

<div id="statsContainer" class="mb-4 hidden">
  <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
    <div id="statNewUsers" class="stat-card" data-action="install" data-label="æ–°ç”¨æˆ·åˆ—è¡¨">
      <div class="stat-value text-blue-500" id="statNewUsersValue">0</div>
      <div class="stat-label">æ–°ç”¨æˆ·æ•°</div>
      <div class="text-xs text-gray-500 mt-1">è´­ä¹°ç‡: <span id="rateBuy">0.00%</span></div>
    </div>
    <div id="statPurchases" class="stat-card" data-action="buy" data-label="è´­ä¹°ç”¨æˆ·åˆ—è¡¨">
      <div class="stat-value text-green-500" id="statPurchasesValue">0</div>
      <div class="stat-label">è´­ä¹°äººæ•°</div>
    </div>
    <div id="statCancellations" class="stat-card" data-action="cancel" data-label="å–æ¶ˆç”¨æˆ·åˆ—è¡¨">
      <div class="stat-value text-orange-500" id="statCancellationsValue">0</div>
      <div class="stat-label">è®¢å•å–æ¶ˆäººæ•°</div>
      <div class="text-xs text-gray-500 mt-1">å–æ¶ˆç‡: <span id="rateCancel">0.00%</span></div>
    </div>
    <div id="statRefunds" class="stat-card" data-action="refund" data-label="é€€æ¬¾ç”¨æˆ·åˆ—è¡¨">
      <div class="stat-value text-red-500" id="statRefundsValue">0</div>
      <div class="stat-label">é€€æ¬¾äººæ•°</div>
      <div class="text-xs text-gray-500 mt-1">é€€æ¬¾ç‡: <span id="rateRefund">0.00%</span></div>
    </div>
  </div>
</div>
<div id="userListControls" class="ant-card mb-4 hidden">
  <div class="flex gap-3 items-center">
    <input id="userListSearch" class="ant-input flex-1" placeholder="æœç´¢ç”¨æˆ·IDã€å›½å®¶æˆ–è®¾å¤‡">
    <button id="userListSortBtn" class="ant-btn" data-sort-field="log_time" data-sort-order="desc">æŒ‰æ—¶é—´ â†“</button>
  </div>
</div>

<div id="userDataContainer" class="ant-card"></div>


<div id="overlay" class="overlay"></div>

<div id="userDrawer" class="drawer">
  <span id="drawerClose" class="drawer-close">&times;</span>

  <h2 class="text-lg font-semibold mb-3" id="drawerTitle">ç”¨æˆ·è¯¦æƒ…</h2>

  <div id="drawerControls" class="flex gap-3 mb-3">
    <input id="drawerSearch" class="ant-input flex-1" placeholder="æœç´¢äº‹ä»¶åç§°ã€IPã€è®¾å¤‡æˆ–Bodyå†…å®¹">
    <button id="drawerSortBtn" class="ant-btn">æŒ‰æ—¶é—´ â†“</button>
  </div>

  <div id="drawerContent"></div>
</div>


<script>
let selectedApp = {name:"VPN Proxy", table:"vpnproxy"};
let selectedCountry = "";
let selectedAction = "userIds"; // é»˜è®¤æ”¹ä¸ºç”¨æˆ·åˆ—è¡¨

// ç»Ÿè®¡æ•°æ®ç¼“å­˜
let userStats = {
  install: [], // æ–°ç”¨æˆ·
  buy: [],     // è´­ä¹°
  cancel: [],  // å–æ¶ˆ
  refund: [],  // é€€æ¬¾
  userIds: [], // ç”¨æˆ·åˆ—è¡¨ (ç”¨äºä¸»è¡¨)
};

// ğŸŒŸ ä¿®æ”¹1: ç”¨æˆ·åˆ—è¡¨æ•°æ®å’Œæ’åºçŠ¶æ€
let currentAllUserList = []; // ç”¨äºå­˜å‚¨ä»æœåŠ¡å™¨è·å–çš„åŸå§‹ç”¨æˆ·åˆ—è¡¨
let currentDisplayedUserList = []; // ç”¨äºå­˜å‚¨å½“å‰æ˜¾ç¤ºçš„ï¼ˆç»è¿‡æœç´¢/æ’åºï¼‰ç”¨æˆ·åˆ—è¡¨

// æŠ½å±‰æ•°æ®å’Œæ’åºçŠ¶æ€
let currentDrawerData = [];
let sortOrder = 'desc'; // 'desc' é™åº (æ—¶é—´æ–°åˆ°æ—§), 'asc' å‡åº (æ—¶é—´æ—§åˆ°æ–°)

const startDateInput = document.getElementById("startDate");
const endDateInput = document.getElementById("endDate");
const drawerSortBtn = document.getElementById("drawerSortBtn");
const userListSearchInput = document.getElementById("userListSearch"); // ğŸŒŸ ä¿®æ”¹1
const userListSortBtn = document.getElementById("userListSortBtn"); // ğŸŒŸ ä¿®æ”¹1
const drawerSearchInput = document.getElementById("drawerSearch"); // ğŸŒŸ ä¿®æ”¹2


// ğŸŒŸ æ–°å¢ï¼šæ ¹æ®å›½å®¶è°ƒæ•´æ—¥æœŸæ—¶é—´è¾¹ç•Œçš„å‡½æ•° (ä¿æŒåŸæ ·)
function getAdjustedDateRange(startDateStr, endDateStr, country) {

    // Helper to format Date object into YYYY-MM-DD HH:MM:SS string
    const formatDateTime = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    };

    let start = new Date(startDateStr);
    let end = new Date(endDateStr);
    
    // åœŸè€³å…¶ (0) æˆ– é˜¿æ‹‰ä¼¯ (1)
    if (country === "0" || country === "1") {
        // 1. å¤„ç† Start Date: å½“å¤© 5:00:00
        start.setHours(5, 0, 0, 0);

        // 2. å¤„ç† End Date: é€‰å®šæ—¥æœŸçš„ç¬¬äºŒå¤© 4:59:59
        // æ­¥éª¤ a: å…ˆå°†æ—¥æœŸè®¾ç½®ä¸ºç»“æŸæ—¥æœŸ (ç”¨æˆ·è¾“å…¥)ï¼Œå¹¶ç¡®ä¿æ—¶é—´æ˜¯ 00:00:00
        end.setHours(0, 0, 0, 0);
        // æ­¥éª¤ b: å¢åŠ ä¸€å¤©
        end.setDate(end.getDate() + 1);
        // æ­¥éª¤ c: è®¾ç½®æ—¶é—´åˆ° 4:59:59
        end.setHours(4, 59, 59, 0);

    } else {
        // ä¸­å›½ ("3") æˆ– å…¨éƒ¨ ("")ï¼šå½“å¤© 00:00:00 åˆ° 23:59:59
        start.setHours(0, 0, 0, 0);
        end.setHours(23, 59, 59, 0);
    }

    return {
        startDateTime: formatDateTime(start),
        endDateTime: formatDateTime(end)
    };
}


function setToday() {
  const t=new Date();
  const y=t.getFullYear(), m=String(t.getMonth()+1).padStart(2,"0"), d=String(t.getDate()).padStart(2,"0");
  startDateInput.value=`${y}-${m}-${d}`;
  endDateInput.value=`${y}-${m}-${d}`;
}
setToday();

/* äº§å“ Tab */
document.querySelectorAll("#productTabs .ant-tab").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll("#productTabs .ant-tab").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    selectedApp = {table:btn.dataset.app, name:btn.dataset.name};
  };
});

/* å›½å®¶é€‰æ‹© */
document.querySelectorAll("#countrySelector .ant-selector").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll("#countrySelector .ant-selector").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    selectedCountry = btn.dataset.value;
  };
});

/* action é€‰æ‹© */
document.querySelectorAll("#actionSelector .ant-selector").forEach(btn=>{
  btn.onclick=()=>{
    document.querySelectorAll("#actionSelector .ant-selector").forEach(b=>b.classList.remove("active"));
    btn.classList.add("active");
    selectedAction = btn.dataset.action;

    // åˆ‡æ¢ç”¨æˆ·åˆ—è¡¨/ç»Ÿè®¡åŒºæ˜¾ç¤º
    if(selectedAction==="userIds"){
      document.getElementById("statsContainer").classList.remove("hidden");
      document.getElementById("userListControls").classList.remove("hidden");
    } else {
      document.getElementById("statsContainer").classList.add("hidden");
      document.getElementById("userListControls").classList.add("hidden"); // å…¶ä»–æ¨¡å¼éšè—åˆ—è¡¨è¿‡æ»¤å™¨
    }

    if(selectedAction==="userData")
      document.getElementById("userIdInputWrapper").classList.remove("hidden");
    else
      document.getElementById("userIdInputWrapper").classList.add("hidden");
  };
});

// é»˜è®¤æ‰§è¡Œä¸€æ¬¡åˆ‡æ¢é€»è¾‘
document.querySelector('#actionSelector .ant-selector[data-action="userIds"]').click();


function vipStatusLabel(s){
  switch(s){
    case 1:return'<span class="px-2 py-1 text-xs bg-green-500 text-white rounded-full">ä¼šå‘˜</span>';
    case 2:return'<span class="px-2 py-1 text-xs bg-orange-500 text-white rounded-full">è¿‡æœŸ</span>';
  }
  return'<span class="px-2 py-1 text-xs bg-gray-300 text-gray-700 rounded-full">æ™®é€š</span>';
}

// ç»Ÿè®¡æ•°æ®ç‚¹å‡»äº‹ä»¶ç»‘å®š
document.querySelectorAll('#statsContainer .stat-card').forEach(card => {
    card.onclick = () => {
        const action = card.dataset.action;
        const label = card.dataset.label;
        const list = userStats[action];
        if (list && list.length > 0) {
            // ğŸŒŸ ä¿®æ”¹5: ä¼ é€’å®Œæ•´åˆ—è¡¨
            openDrawerWithUserIds(list, label);
        } else {
            alert(`å½“å‰æ²¡æœ‰ ${label}`);
        }
    };
});


document.getElementById("fetchBtn").onclick = async ()=>{

  const admin=document.getElementById("adminId").value.trim();
  if(!admin) return alert("è¯·è¾“å…¥ç®¡ç†å‘˜ID");

  // ğŸŒŸ é”™è¯¯å¤„ç†ï¼šæ£€æŸ¥æ—¥æœŸ
  if (!startDateInput.value || !endDateInput.value) return alert("è¯·é€‰æ‹©å¼€å§‹æ—¥æœŸå’Œç»“æŸæ—¥æœŸ");


  // ğŸŒŸ è·å–è°ƒæ•´åçš„æ—¶é—´èŒƒå›´
  const { startDateTime, endDateTime } = getAdjustedDateRange(startDateInput.value, endDateInput.value, selectedCountry);
  
  
  if(selectedAction==="userIds"){
      // æ‰¹é‡è¯·æ±‚ç»Ÿè®¡æ•°æ®
      await fetchStats(admin, startDateTime, endDateTime); // ä¼ é€’è°ƒæ•´åçš„æ—¶é—´
      // ğŸŒŸ ä¿®æ”¹1: æ¸²æŸ“ç”¨æˆ·åˆ—è¡¨ (ä½¿ç”¨å®Œæ•´æ•°æ®è¿›è¡Œåˆå§‹åŒ–)
      currentAllUserList = userStats.userIds;
      applyUserListFilterAndSort();
      return;
  }
  
  if(selectedAction==="userData" && !document.getElementById("userIdInput").value) {
      return alert("è¯·è¾“å…¥ç”¨æˆ·ID");
  }

  // å…¶ä»– action çš„åŸæœ‰é€»è¾‘
  const url=new URL("https://analyze.yuanma.live/event");
  url.searchParams.append("table",selectedApp.table);
  url.searchParams.append("action",selectedAction);
  url.searchParams.append("adminId",admin);
  
  // ğŸŒŸ ä½¿ç”¨è°ƒæ•´åçš„æ—¶é—´
  url.searchParams.append("startDate", startDateTime);
  url.searchParams.append("endDate", endDateTime);

  if(selectedAction==="retention"||selectedAction==="userIds")
    url.searchParams.append("country",selectedCountry);

  if(selectedAction==="userData")
    url.searchParams.append("userId",document.getElementById("userIdInput").value);

  try {
      const res=await fetch(url);
      if(!res.ok) throw new Error(res.statusText);
      renderResult(await res.json());
  } catch(error) {
      alert(`æŸ¥è¯¢å¤±è´¥: ${error.message}`);
  }
};

// ğŸŒŸ ä¿®æ”¹ï¼šæ‰¹é‡è·å–ç»Ÿè®¡æ•°æ®ï¼Œç°åœ¨æ¥å—è°ƒæ•´åçš„æ—¶é—´
async function fetchStats(adminId, startDateTime, endDateTime) {
    // ğŸŒŸ ä¼˜åŒ–ï¼šæ·»åŠ  name å‚æ•°åˆ° actionMap
    const actionMap = {
        "install": "install",
        "buy": "subscribe_page_success,guide_start_success",
        "cancel": "cancel",
        "refund": "refund",
        "userIds": null
    };
    const actions = Object.keys(actionMap);
    const country = selectedCountry;
    const table = selectedApp.table;

    const promises = actions.map(action => {
        const url = new URL("https://analyze.yuanma.live/event");
        url.searchParams.append("table", table);
        url.searchParams.append("action", action);
        url.searchParams.append("adminId", adminId);
        
        // ğŸŒŸ ä½¿ç”¨ä¼ å…¥çš„è°ƒæ•´åçš„æ—¶é—´
        url.searchParams.append("startDate", startDateTime);
        url.searchParams.append("endDate", endDateTime);
        
        if(action !== 'userData') {
          url.searchParams.append("country", country);
        }

        // æ·»åŠ  name å‚æ•°
        if(actionMap[action]) {
             url.searchParams.append("name", actionMap[action]);
        }

        return fetch(url).then(res => {
            if (!res.ok) throw new Error(res.statusText);
            return res.json();
        }).then(data => ({ action, data }))
          .catch(error => {
            console.error(`Fetching ${action} failed:`, error);
            return { action, data: [] }; // å¤±è´¥æ—¶è¿”å›ç©ºæ•°ç»„
          });
    });

    const results = await Promise.all(promises);

    results.forEach(item => {
        userStats[item.action] = item.data;
    });

    updateStatsDisplay();
}

// æ›´æ–°ç»Ÿè®¡æ•°æ®æ˜¾ç¤º
function updateStatsDisplay() {
    const installCount = userStats.install.length;
    const buyCount = userStats.buy.length;
    const cancelCount = userStats.cancel.length;
    const refundCount = userStats.refund.length;

    document.getElementById("statNewUsersValue").textContent = installCount;
    document.getElementById("statPurchasesValue").textContent = buyCount;
    document.getElementById("statCancellationsValue").textContent = cancelCount;
    document.getElementById("statRefundsValue").textContent = refundCount;

    // è®¡ç®—æ¯”ç‡
    const rateBuy = installCount > 0 ? (buyCount / installCount * 100).toFixed(2) : "0.00";
    const rateCancel = buyCount > 0 ? (cancelCount / buyCount * 100).toFixed(2) : "0.00";
    const rateRefund = buyCount > 0 ? (refundCount / buyCount * 100).toFixed(2) : "0.00";

    document.getElementById("rateBuy").textContent = `${rateBuy}%`;
    document.getElementById("rateCancel").textContent = `${rateCancel}%`;
    document.getElementById("rateRefund").textContent = `${rateRefund}%`;
}


function renderResult(data){
  const box=document.getElementById("userDataContainer");
  box.innerHTML="";

  if(selectedAction==="retention"){
    let html=`<table class="ant-table"><thead><tr>
      <th>æ—¥æœŸ</th><th>æ–°å¢</th><th>Day1 ç•™å­˜</th><th>ç•™å­˜ç‡%</th></tr></thead><tbody>`;
    data.forEach(d=>{
      // ğŸŒŸ ä¿®æ”¹3: ä½¿ç”¨ period_start å¹¶æˆªå–æ—¥æœŸéƒ¨åˆ†
      const date = d.period_start ? d.period_start.substring(0, 10) : 'æœªçŸ¥æ—¥æœŸ';
      html+=`<tr><td>${date}</td><td>${d.new_user_count}</td><td>${d.day1_retention}</td>
        <td>${(d.day1_rate*100).toFixed(2)}%</td></tr>`;
    });
    html+="</tbody></table>";
    box.innerHTML=html;
    return;
  }

  if(selectedAction==="vipCount"){
    box.innerHTML=`<p class="text-lg">VIPäººæ•°ï¼š<b class="text-green-600">${data.count||0}</b></p>`;
    return;
  }

  if(selectedAction==="userIds"){
    // ğŸŒŸ ä¿®æ”¹1: è¿™ä¸ªåˆ†æ”¯åœ¨ fetchBtn.onclick ä¸­å¤„ç†äº†ï¼Œæ­¤åˆ†æ”¯ç†è®ºä¸Šä¸ä¼šè¢«æ‰§è¡Œã€‚
    // å¦‚æœæ‰§è¡Œåˆ°è¿™é‡Œï¼Œè¯´æ˜æ•°æ®æ˜¯ç›´æ¥ä» renderResult æ¥çš„ï¼Œæˆ‘ä»¬ä¿æŒå…¼å®¹ã€‚
    currentAllUserList = data;
    applyUserListFilterAndSort();
    return;
  }
  
  if(selectedAction==="userData"){ openDrawerWithData(data); return; }
}

// ğŸŒŸ ä¿®æ”¹1: ç”¨æˆ·åˆ—è¡¨çš„æœç´¢å’Œæ’åºé€»è¾‘
function applyUserListFilterAndSort() {
    let filteredList = currentAllUserList;
    const searchText = userListSearchInput.value.toLowerCase().trim();
    const sortField = userListSortBtn.dataset.sortField;
    const sortOrder = userListSortBtn.dataset.sortOrder;

    // 1. è¿‡æ»¤/æœç´¢
    if (searchText) {
        filteredList = currentAllUserList.filter(d => {
            return d.user_id.toLowerCase().includes(searchText) ||
                   d.country_code.toLowerCase().includes(searchText) ||
                   d.device.toLowerCase().includes(searchText);
        });
    }

    // 2. æ’åº
    filteredList.sort((a, b) => {
        let valA, valB;

        if (sortField === 'log_time') {
            valA = new Date(a.log_time);
            valB = new Date(b.log_time);
        } else if (sortField === 'vip_status') {
            valA = a.vip_status;
            valB = b.vip_status;
        } else {
            // é»˜è®¤æŒ‰ user_id å­—ç¬¦ä¸²æ’åº
            valA = a[sortField] || '';
            valB = b[sortField] || '';
        }

        if (valA < valB) return sortOrder === 'asc' ? -1 : 1;
        if (valA > valB) return sortOrder === 'asc' ? 1 : -1;
        return 0;
    });

    currentDisplayedUserList = filteredList;
    renderUserList(currentDisplayedUserList);
}

// ğŸŒŸ ä¿®æ”¹1: ç”¨æˆ·åˆ—è¡¨æ’åºæŒ‰é’®äº‹ä»¶
userListSortBtn.onclick = () => {
    let currentField = userListSortBtn.dataset.sortField;
    let currentOrder = userListSortBtn.dataset.sortOrder;
    let newField, newOrder;

    // åˆ‡æ¢æ’åºå­—æ®µå’Œé¡ºåº
    if (currentField === 'log_time') {
        newField = 'vip_status';
        newOrder = 'desc';
    } else if (currentField === 'vip_status') {
        newField = 'log_time';
        newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
    } else { // é»˜è®¤ä¸º log_time
        newField = 'log_time';
        newOrder = currentOrder === 'desc' ? 'asc' : 'desc';
    }

    userListSortBtn.dataset.sortField = newField;
    userListSortBtn.dataset.sortOrder = newOrder;

    // æ›´æ–°æŒ‰é’®æ–‡æœ¬
    const orderIcon = newOrder === 'desc' ? 'â†“' : 'â†‘';
    let fieldText = newField === 'log_time' ? 'æ—¶é—´' : 'VIP';
    userListSortBtn.textContent = `æŒ‰${fieldText} ${orderIcon}`;

    applyUserListFilterAndSort();
};

// ğŸŒŸ ä¿®æ”¹1: ç”¨æˆ·åˆ—è¡¨æœç´¢æ¡†äº‹ä»¶
userListSearchInput.oninput = applyUserListFilterAndSort;


function renderUserList(list){
  const box=document.getElementById("userDataContainer");
  box.innerHTML="";
  
  let html=`<table class="ant-table"><thead><tr>
    <th>UserID</th><th>å›½å®¶</th><th>è®¾å¤‡</th><th>VIP</th><th>æœ€åè®°å½•æ—¶é—´</th><th>æ“ä½œ</th></tr></thead><tbody>`;
  list.forEach(d=>{
    html+=`<tr><td>${d.user_id}</td><td>${d.country_code}</td><td>${d.device}</td>
      <td>${vipStatusLabel(d.vip_status)}</td>
      <td>${d.log_time}</td>
      <td><button class="ant-btn openUserBtn" data-id="${d.user_id}">æ‰“å¼€</button></td></tr>`;
  });
  html+="</tbody></table>";
  box.innerHTML=html;

  document.querySelectorAll(".openUserBtn").forEach(btn=>{
    btn.onclick=()=>fetchUser(btn.dataset.id);
  });
}

async function fetchUser(uid){
  const admin=document.getElementById("adminId").value.trim();
  const url=new URL("https://analyze.yuanma.live/event");
  url.searchParams.append("action","userData");
  url.searchParams.append("table",selectedApp.table);
  url.searchParams.append("adminId",admin);
  url.searchParams.append("userId",uid);
  try {
      const res=await fetch(url);
      if(!res.ok) throw new Error(res.statusText);
      openDrawerWithData(await res.json());
  } catch(error) {
      alert(`æŸ¥è¯¢ç”¨æˆ·è¯¦æƒ…å¤±è´¥: ${error.message}`);
  }
}

const overlay=document.getElementById("overlay");
const drawer=document.getElementById("userDrawer");
document.getElementById("drawerClose").onclick=closeDrawer;
overlay.onclick=closeDrawer;

// ç»‘å®šæŠ½å±‰æ’åºæŒ‰é’®äº‹ä»¶ (ä¿æŒåŸæ ·)
drawerSortBtn.onclick = sortDrawerData;

// ğŸŒŸ ä¿®æ”¹2: ç»‘å®šæŠ½å±‰æœç´¢æŒ‰é’®äº‹ä»¶
drawerSearchInput.oninput = applyDrawerSearch;


function closeDrawer(){
    drawer.classList.remove("open");
    overlay.classList.remove("show");
}

// ğŸŒŸ ä¿®æ”¹2: æŠ½å±‰æœç´¢é€»è¾‘
function applyDrawerSearch() {
    const searchText = drawerSearchInput.value.toLowerCase().trim();
    if (!searchText) {
        // å¦‚æœæ¸…ç©ºæœç´¢ï¼Œé‡æ–°åº”ç”¨æ’åºå¹¶æ¸²æŸ“å…¨éƒ¨
        sortDrawerData(true);
        return;
    }

    // è¿‡æ»¤æ•°æ®ï¼šåŸºäºå­˜å‚¨åœ¨ currentDrawerData çš„åŸå§‹æ•°æ®è¿›è¡Œè¿‡æ»¤
    const filteredList = currentDrawerData.filter(d => {
        // æœç´¢äº‹ä»¶ã€IPã€è®¾å¤‡ã€Body
        const bodyContent = formatBodyContent(d.body);
        return d.name.toLowerCase().includes(searchText) ||
               d.ip.toLowerCase().includes(searchText) ||
               d.device.toLowerCase().includes(searchText) ||
               bodyContent.toLowerCase().includes(searchText);
    });

    renderDrawerContent(filteredList);
}


// æŠ½å±‰æ•°æ®æ’åºé€»è¾‘
function sortDrawerData(reset = false) {
    if (currentDrawerData.length === 0) return;

    if (!reset) {
        // åˆ‡æ¢æ’åºçŠ¶æ€
        sortOrder = sortOrder === 'desc' ? 'asc' : 'desc';
    } else {
        // å¦‚æœæ˜¯é‡ç½®ï¼Œç¡®ä¿æ’åºçŠ¶æ€åæ˜ åœ¨æŒ‰é’®ä¸Šï¼Œä½†ä¸éœ€è¦åˆ‡æ¢
        sortOrder = 'desc'; // é‡ç½®åé»˜è®¤é™åº
    }
    
    // ç¡®ä¿æœç´¢æ¡†æ¸…ç©º
    drawerSearchInput.value = '';

    // æ’åºæ•°æ®ï¼šä½¿ç”¨ log_time è¿›è¡Œæ¯”è¾ƒ
    currentDrawerData.sort((a, b) => {
        const dateA = new Date(a.log_time);
        const dateB = new Date(b.log_time);
        return sortOrder === 'desc' ? dateB - dateA : dateA - dateB;
    });

    // æ›´æ–°æŒ‰é’®æ˜¾ç¤º
    drawerSortBtn.textContent = sortOrder === 'desc' ? 'æŒ‰æ—¶é—´ â†“' : 'æŒ‰æ—¶é—´ â†‘';

    // é‡æ–°æ¸²æŸ“æŠ½å±‰å†…å®¹
    renderDrawerContent(currentDrawerData);
}

// ğŸŒŸ æ–°å¢ï¼šBodyå†…å®¹æ ¼å¼åŒ–å‡½æ•° (ç”¨äºè¯¦æƒ…è§£æå’Œæœç´¢)
function formatBodyContent(body) {
    if (!body) return '';
    return body.split('|')
               .filter(item => item.trim() !== '')
               .map(item => `<div class="text-xs text-gray-700">${item.trim()}</div>`)
               .join('');
}


// æ¸²æŸ“æŠ½å±‰å†…å®¹çš„é€šç”¨å‡½æ•°
function renderDrawerContent(list) {
    const box = document.getElementById("drawerContent");
    let html=`<table class="ant-table"><thead><tr>
        <th style="text-align: left;">æ—¶é—´</th><th style="text-align: center;">äº‹ä»¶</th><th style="text-align: left;">è¯¦æƒ…</th></tr></thead><tbody>`;
    list.forEach(d=>{
        // ğŸŒŸ ä¿®æ”¹2: é‡æ–°æ ¼å¼åŒ–è¯¦æƒ…åˆ—
        const detailHtml = `
            <div class="text-left text-xs space-y-1">
                <div><span class="font-semibold">IP:</span> ${d.ip}</div>
                <div><span class="font-semibold">è®¾å¤‡:</span> ${d.device} (${d.device_detail})</div>
                <div><span class="font-semibold">åœ°åŒº:</span> ${d.area}</div>
                <div><span class="font-semibold">VPN:</span> ${d.vpn_status === 1 ? 'å¼€å¯' : 'å…³é—­'} | <span class="font-semibold">VIP:</span> ${vipStatusLabel(d.vip_status)}</div>
                ${d.vip_status > 0 ? `<div><span class="font-semibold">VIPè¿‡æœŸ:</span> ${d.vip_expire_date || '-'} (${d.vip_expire_days}å¤©)</div>` : ''}
                ${d.ad_showed > 0 || d.ad_clicked > 0 ? `<div><span class="font-semibold">å¹¿å‘Š:</span> å±•ç¤º ${d.ad_showed} | ç‚¹å‡» ${d.ad_clicked}</div>` : ''}
                ${d.body ? `<div><span class="font-semibold">Body:</span> ${formatBodyContent(d.body)}</div>` : ''}
            </div>
        `;
        html+=`<tr>
            <td style="text-align: left;">${d.log_time}</td>
            <td style="text-align: center;">${d.name}</td>
            <td style="text-align: left;">${detailHtml}</td>
        </tr>`;
    });
    html+="</tbody></table>";
    box.innerHTML=html;
}


// å•ç”¨æˆ·æ•°æ®è¯¦æƒ…æŠ½å±‰ (ä¿®æ”¹ï¼šå­˜å‚¨æ•°æ®å¹¶è°ƒç”¨é€šç”¨æ¸²æŸ“)
function openDrawerWithData(list){
    document.getElementById("drawerTitle").textContent = "ç”¨æˆ·è¯¦æƒ…";
    document.getElementById("drawerControls").classList.remove("hidden"); // æ˜¾ç¤ºæœç´¢/æ’åº

    // å­˜å‚¨æ•°æ®å’Œé‡ç½®æ’åºçŠ¶æ€
    currentDrawerData = list;
    drawerSearchInput.value = ''; // ğŸŒŸ ä¿®æ”¹2: æ¸…ç©ºæœç´¢æ¡†
    sortOrder = 'desc'; // é»˜è®¤é™åº
    drawerSortBtn.textContent = 'æŒ‰æ—¶é—´ â†“';

    // é»˜è®¤æ’åºå¹¶æ¸²æŸ“
    currentDrawerData.sort((a, b) => new Date(b.log_time) - new Date(a.log_time));
    renderDrawerContent(currentDrawerData);

    drawer.classList.add("open");
    overlay.classList.add("show");
}

// ç»Ÿè®¡ç”¨æˆ·åˆ—è¡¨æŠ½å±‰
function openDrawerWithUserIds(list, title) {
    document.getElementById("drawerTitle").textContent = title;
    document.getElementById("drawerControls").classList.add("hidden"); // éšè—æœç´¢/æ’åº

    // æ¸…ç©ºæ•°æ®ç¼“å­˜ï¼Œé¿å…æ··æ·†
    currentDrawerData = [];

    const box = document.getElementById("drawerContent");
    let html = `<table class="ant-table"><thead><tr>
        <th>UserID</th><th>å›½å®¶</th><th>è®¾å¤‡</th><th>VIP</th><th>æœ€åè®°å½•æ—¶é—´</th></tr></thead><tbody>`;
    // ğŸŒŸ ä¿®æ”¹5: æ¸²æŸ“æ›´å¤šä¿¡æ¯
    list.forEach(d => {
        html += `<tr>
            <td>${d.user_id}</td>
            <td>${d.country_code}</td>
            <td>${d.device}</td>
            <td>${vipStatusLabel(d.vip_status)}</td>
            <td>${d.log_time}</td>
        </tr>`;
    });
    html += "</tbody></table>";
    box.innerHTML = html;

    drawer.classList.add("open");
    overlay.classList.add("show");
}
</script>

</body>
</html>
